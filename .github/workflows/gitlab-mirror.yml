name: Mirror to GitLab

on:
  push:
    branches: [ main ]

jobs:
  mirror:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Mirror to GitLab (HTTPS Deploy Token)
        shell: bash
        env:
          GITLAB_HTTPS_URL: ${{ secrets.GITLAB_HTTPS_URL }}
          GITLAB_DEPLOY_USER: ${{ secrets.GITLAB_DEPLOY_USER }}
          GITLAB_DEPLOY_TOKEN: ${{ secrets.GITLAB_DEPLOY_TOKEN }}
        run: |
          set -euo pipefail

          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 1
          git config --global http.lowSpeedTime 600
          git config --global http.version HTTP/1.1
          git config --global core.compression 0

          git remote remove gitlab 2>/dev/null || true

          git remote add gitlab "https://${GITLAB_DEPLOY_USER}:${GITLAB_DEPLOY_TOKEN}@${GITLAB_HTTPS_URL}"

          git fetch gitlab main
          git rebase gitlab/main

          for i in 1 2 3; do
            echo "Push attempt $i..."
            if git push gitlab HEAD:main --force-with-lease; then
              exit 0
            fi
            echo "Push failed, retrying in $((i*10))s..."
            sleep $((i*10))
          done

          exit 1
